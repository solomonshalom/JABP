name: Release

on:
  push:
    tags:
      - 'JesusW-V*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
          - platform: macos-latest
            args: --target x86_64-apple-darwin
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies
        run: bun install

      - name: Build Tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'JABP - ${{ github.ref_name }}'
          releaseBody: |
            Spin the disc. Feel the grooves.

            **Downloads:**
            - `.dmg` - macOS (Apple Silicon & Intel)
            - `.exe` / `.msi` - Windows
            - `.apk` - Android
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  build-android:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r27b
          link-to-sdk: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Install dependencies
        run: bun install

      - name: Initialize Android project
        run: bun run tauri android init

      - name: Add Android permissions
        run: |
          MANIFEST="src-tauri/gen/android/app/src/main/AndroidManifest.xml"
          # Add INTERNET and VIBRATE permissions before the <application tag
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />\n    <uses-permission android:name="android.permission.VIBRATE" />' "$MANIFEST"

      - name: Build Android
        run: bun run tauri android build
        env:
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Sign APK
        run: |
          # Generate a signing keystore
          keytool -genkeypair -v \
            -keystore release.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias jabp \
            -storepass jabprelease \
            -keypass jabprelease \
            -dname "CN=JABP, O=JABP, L=Unknown, ST=Unknown, C=US"

          # Find the unsigned APK
          APK=$(find src-tauri/gen/android/app/build/outputs/apk -name '*.apk' | head -1)

          # Align the APK
          "${ANDROID_HOME}/build-tools/$(ls "${ANDROID_HOME}/build-tools/" | sort -V | tail -1)/zipalign" -v -p 4 "$APK" aligned.apk

          # Sign with apksigner
          "${ANDROID_HOME}/build-tools/$(ls "${ANDROID_HOME}/build-tools/" | sort -V | tail -1)/apksigner" sign \
            --ks release.jks \
            --ks-key-alias jabp \
            --ks-pass pass:jabprelease \
            --key-pass pass:jabprelease \
            --out JABP-android.apk \
            aligned.apk

          # Verify
          "${ANDROID_HOME}/build-tools/$(ls "${ANDROID_HOME}/build-tools/" | sort -V | tail -1)/apksigner" verify JABP-android.apk

      - name: Upload APK to release
        run: gh release upload "${{ github.ref_name }}" JABP-android.apk --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
